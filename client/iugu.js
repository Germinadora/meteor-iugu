(function(e,t){function s(){if(!r){r=!0;for(var e=0;e<n.length;e++)n[e].fn.call(window,n[e].ctx);n=[]}}function o(){document.readyState==="complete"&&s()}e=e||"docReady",t=t||window;var n=[],r=!1,i=!1;t[e]=function(e,t){if(r){setTimeout(function(){e(t)},1);return}n.push({fn:e,ctx:t}),document.readyState==="complete"?setTimeout(s,1):i||(document.addEventListener?(document.addEventListener("DOMContentLoaded",s,!1),window.addEventListener("load",s,!1)):(document.attachEvent("onreadystatechange",o),window.attachEvent("onload",s)),i=!0)}})("dispatchOnLoad",window);Iugu=function(){function u(e,t){var n,r,i;r=e.getElementsByTagName("input"),i=e.getElementsByTagName("select"),n={};for(var s=0;s<r.length;s++){attr=r[s].getAttribute("data-iugu");if(attr==null)continue;if(t.indexOf(attr)==-1)continue;n[attr]=r[s].value,attr=="full_name"&&(splitted_name=Iugu.utils.getFirstLastNameByFullName(r[s].value),n.first_name=splitted_name[0],n.last_name=splitted_name[1])}for(var s=0;s<i.length;s++){attr=i[s].getAttribute("data-iugu");if(attr==null)continue;if(t.indexOf(attr)==-1)continue;i[s].selectedIndex!=null&&(n[attr]=i[s].options[i[s].selectedIndex].value)}return n}function a(e,t,n){t==null&&(t=[]);for(index in e)param=e[index],n&&(index=n+"["+index+"]"),typeof param=="object"?a(param,t,index):t.push(index+"="+encodeURIComponent(param));return t.join("&").replace(/%20/g,"+")}function f(){return t+"/"+n+"/"}function l(e,t){var n=t.callbackName||"callback",i=t.onSuccess||function(){},s=t.onTimeout||function(){},o=t.onError||function(){},u=t.timeout||10,f=t.data||{},l=n;if(window[l]==1)return;var c=(new Date).getTime();n+=++c,f.account_id=r,f.callback=n;var h=document.createElement("script");window[l]=!0;var p=function(){try{delete window[n],delete window[l]}catch(e){window[n]=void 0,window[l]=undefined}},d=window.setTimeout(function(){window[l]=undefined},u*1e3),v=window.setTimeout(function(){window[n]=function(){},s(),document.getElementsByTagName("head")[0].removeChild(h),p()},u*1e3);window[n]=function(e){window.clearTimeout(v),i(e),document.getElementsByTagName("head")[0].removeChild(h),p()},h.type="text/javascript",h.async=!0,h.src=e+"?"+a(f),h.onerror=function(){window.clearTimeout(v),o(),document.getElementsByTagName("head")[0].removeChild(h),p()},document.getElementsByTagName("head")[0].appendChild(h)}var e=function(){try{var e=window.localStorage}catch(t){}try{var n=window.sessionStorage}catch(r){}var i="ig_fp";return generateGUID=typeof window.crypto!="undefined"&&typeof window.crypto.getRandomValues!="undefined"?function(){var e=new Uint16Array(8);window.crypto.getRandomValues(e);var t=function(e){var t=e.toString(16);while(t.length<4)t="0"+t;return t};return t(e[0])+t(e[1])+"-"+t(e[2])+"-"+t(e[3])+"-"+t(e[4])+"-"+t(e[5])+t(e[6])+t(e[7])}:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},readwrite_db=function(e,t){try{if(window.openDatabase){var n=window.openDatabase("sqlite_"+i,"",i,1048576);t!==undefined?n.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS data (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, value TEXT NOT NULL, UNIQUE (name))",[],function(e,t){},function(e,t){}),n.executeSql("INSERT OR REPLACE INTO data (name, value) VALUES(?, ?)",[e,t],function(e,t){},function(e,t){})}):n.transaction(function(t){t.executeSql("SELECT value FROM data WHERE name=?",[e],function(e,t){t.rows.length>=1?self._ec.dbData=t.rows.item(0).value:self._ec.dbData=""},function(e,t){})})}}catch(r){}},readwrite_local=function(t,n){try{if(e){if(n===undefined)return e.getItem(t);e.setItem(t,n)}}catch(r){}},readwrite_index=function(e,t){try{"indexedDB"in window||(indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange);if(indexedDB){var n=1,r=indexedDB.open("idb_"+i,n);r.onerror=function(e){},r.onupgradeneeded=function(e){var t=e.target.result,n=t.createObjectStore(i,{keyPath:"name",unique:!1})},t!==undefined?r.onsuccess=function(n){var r=n.target.result;if(r.objectStoreNames.contains(i))var s=r.transaction([i],"readwrite"),o=s.objectStore(i),u=o.put({name:e,value:t});r.close()}:r.onsuccess=function(t){var n=t.target.result;if(!n.objectStoreNames.contains(i))window.iugu_idbData=undefined;else{var r=n.transaction([i]),s=r.objectStore(i),o=s.get(e);o.onsuccess=function(e){o.result===undefined?window.iugu_idbData=undefined:window.iugu_idbData=o.result.value}}n.close()}}}catch(s){}},readwrite_session=function(e,t){try{if(n){if(t===undefined)return n.getItem(e);n.setItem(e,t)}}catch(r){}},readwrite_global=function(e,t){if(window.globalStorage)try{if(t===undefined)return window.globalStorage["iugu.com"][e];window.globalStorage["iugu.com"][e]=t}catch(n){}},readwrite_cookie=function(e,t){if(t===undefined)return readwrite_getFromStr(e,document.cookie);document.cookie=e+"=; expires=Mon, 20 Sep 2010 00:00:00 UTC; path=/; domain=iugu.com",document.cookie=e+"="+t+"; expires=Tue, 31 Dec 2030 00:00:00 UTC; path=/; domain=iugu.com"},readwrite_getFromStr=function(e,t){if(typeof t!="string")return;var n=e+"=",r=t.split(/[;&]/),i,s;for(i=0;i<r.length;i++){s=r[i];while(s.charAt(0)===" ")s=s.substring(1,s.length);if(s.indexOf(n)===0)return s.substring(n.length,s.length)}},{generate:function(){return value=readwrite_cookie("__ifpi"),value!=null?value:(value=readwrite_session("__ifpi"),value!=null?value:(value=readwrite_global("__ifpi"),value!=null?value:(value=readwrite_local("__ifpi"),value!=null?value:(value=readwrite_index("__ifpi"),value!=null?value:(value=readwrite_db("__ifpi"),value!=null?value:(_validFP=generateGUID(),readwrite_cookie("__ifpi",_validFP),readwrite_session("__ifpi",_validFP),readwrite_global("__ifpi",_validFP),readwrite_local("__ifpi",_validFP),readwrite_index("__ifpi",_validFP),readwrite_db("__ifpi",_validFP),_validFP))))))}}}(),t="https://api.iugu.com",n="v1",r=null,i=!1,s=["number","verification_value","first_name","last_name","expiration","expiration_month","expiration_year","full_name"];window.hasOwnProperty=window.hasOwnProperty||Object.prototype.hasOwnProperty,Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){for(var n=t||0,r=this.length;n<r;n++)if(this[n]===e)return n;return-1}),typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Object.keys||(Object.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t});var o={listen:function(e,t,n){if(t.addEventListener)t.addEventListener(e,n,!1);else if(t.attachEvent){var r=t.attachEvent("on"+e,n);return r}},hasClass:function(e,t){return e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))},addClass:function(e,t){o.hasClass(e,t)||(e.className+=" "+t)},removeClass:function(e,t){if(o.hasClass(e,t)){var n=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(n," "),e.className=e.className.replace("  "," "),e.className=e.className.trim()}}};return cards={visa:{cvv_pattern:/^[0-9]{3}$/,brand:[40,41,42,43,44,45,46,47,48,49]},mastercard:{cvv_pattern:/^[0-9]{3}$/,brand:[50,51,52,53,54,55,56,57,58,59]},amex:{cvv_pattern:/^[0-9]{4}$/,brand:[34,37]},diners:{cvv_pattern:/^[0-9]{3}$/,brand:[30,36,38,39]},elo:{cvv_pattern:/^[0-9]{3}$/,brand:[63]}},utils={validateAccountID:function(e){if(!/^[a-fA-F0-9]{8}[a-fA-F0-9]{4}[a-fA-F0-9]{4}[a-fA-F0-9]{4}[a-fA-F0-9]{12}$/.test(e))return"ID de Conta (AccountID) inválido.\r\nConfigure usando o método setAccountID()"},formatUUID:function(e){var t=e.toUpperCase().replace("-","");return t.substr(0,8)+"-"+t.substr(8,4)+"-"+t.substr(12,4)+"-"+t.substr(16,4)+"-"+t.substr(20,12)},validateCreditCardNumber:function(e){if(e.length==0||/[^0-9-\s]+/.test(e))return!1;var t=0,n=0,r=!1;e=e.replace(/\D/g,"");for(var i=e.length-1;i>=0;i--){var s=e.charAt(i),n=parseInt(s,10);r&&(n*=2)>9&&(n-=9),t+=n,r=!r}return t%10==0},validateCVV:function(e,t){return t?cards[t]?cards[t].cvv_pattern.test(e):!1:!1},validateExpiration:function(e,t){today=new Date;if(e==undefined)return!1;if(e>12||e<1)return!1;if(t==undefined)return!1;t.length==2&&(t=today.getFullYear().toString().substr(0,2)+t);if(t<today.getFullYear())return!1;if(t==today.getFullYear()){if(e>12||e<today.getMonth()+1)return!1}else if(t>today.getFullYear())if(e>12||e<1)return!1;return!0},validateExpirationString:function(e){return e=this.getMonthYearByFullExpiration(e),!e||e.length!=2?!1:this.validateExpiration(e[0],e[1])},validateFirstName:function(e){return!e||e.length==0?!1:!0},validateLastName:function(e){return!e||e.length==0?!1:!0},getMonthYearByFullExpiration:function(e){return e?(e=e.toString().split("/"),!e||e.length!=2?!1:[e[0],e[1]]):!1},getFirstLastNameByFullName:function(e){return e?(e=e.toString().split(" "),[e.shift(),e.join(" ")]):!1},getBrandByCreditCardNumber:function(e){first_two=parseInt(e.slice(0,2));for(var t in cards)if(cards.hasOwnProperty(t)){var n=cards[t];if(cards[t].brand.indexOf(first_two)!=-1)return utils.keyOf(cards,cards[t])}return!1},trim:function(e){return e.replace(/^\s+/g,"").replace(/\s+$/,"")},keyOf:function(e,t){for(var n in e)if(hasOwnProperty.call(e,n)&&e[n]===t)return n;return null}},{utils:utils,CreditCard:function(e,t,n,r,i,s){e=e,e&&(e=e.replace(/ +/g,""),e=e.replace(/-+/g,"")),t=t,n=n;var o=new Date;return n!=undefined&&n.length==2&&(n=o.getFullYear().toString().substr(0,2)+n),r=r,i=i,r!=undefined&&(r=r.toUpperCase()),i!=undefined&&(i=i.toUpperCase()),s=s,{errors:function(){_errors={};if(!e||!utils.validateCreditCardNumber(e))_errors.number="is_invalid";if(!s||!utils.validateCVV(s,utils.getBrandByCreditCardNumber(e)))_errors.verification_value="is_invalid";if(!t||!n||!utils.validateExpiration(t,n))_errors.expiration="is_invalid";if(!r||!utils.validateFirstName(r))_errors.first_name="is_invalid";if(!i||!utils.validateLastName(i))_errors.last_name="is_invalid";return _errors},valid:function(){return Object.keys(this.errors()).length>0?!1:!0},brand:function(){return utils.getBrandByCreditCardNumber(e)},toData:function(){return{number:e,verification_value:s,first_name:r,last_name:i,month:t,year:n,brand:this.brand()}}}},createPaymentToken:function(t,n){err=utils.validateAccountID(r);if(err){alert(err);return}cc=!1,t.tagName!==undefined&&t.tagName.toUpperCase()=="FORM"?(formData=u(t,s),expiration=this.utils.getMonthYearByFullExpiration(formData.expiration),cc=this.CreditCard(formData.number,expiration[0],expiration[1],formData.first_name,formData.last_name,formData.verification_value)):t.toData!==undefined?cc=t:t.number!==undefined&&(cc=this.CreditCard(t.number,t.month,t.year,t.first_name,t.last_name,t.verification_value));var o=n||function(){};if(!cc.valid())return o({errors:cc.errors()});cc_data=cc.toData(),cc_data.fingerprint=e.generate(),data={method:"credit_card",data:cc_data},i==1&&(data.test=1),l(f()+"payment_token",{data:data,onSuccess:function(e){e.errors==undefined&&e.id.length==32&&(e.id=utils.formatUUID(e.id)),o(e)},onTimeout:function(){o({errors:{timeout:"operation_timeout"}})}})},setAccountID:function(e){typeof e=="string"?r=e.replace(/\-/g,"").toUpperCase():r=e,this.setup()},setTestMode:function(e){i=e},setup:function(){var e=!1;typeof Formatter!="undefined"&&(e=!0),typeof this.initializedFields=="undefined"&&(this.initializedFields=[]);if(e==0)return;inputs=document.getElementsByTagName("input");for(var t=0;t<inputs.length;t++){attr=inputs[t].getAttribute("data-iugu");if(attr==null)continue;if(this.initializedFields.indexOf(inputs[t])!=-1)continue;this.initializedFields.push(inputs[t]);if(attr=="number"){var n=inputs[t];formatter=new Formatter(n,{pattern:"{{9999}} {{9999}} {{9999}} {{9999}}",persistent:!1}),o.listen("keyup",n,function(e){number=n.value.replace(/\ /g,""),number=number.replace(/\-/g,""),brand=utils.getBrandByCreditCardNumber(number),form=n.form;if(o.hasClass(form,brand))return;o.removeClass(form,"visa"),o.removeClass(form,"mastercard"),o.removeClass(form,"amex"),o.removeClass(form,"diners"),o.removeClass(form,"elo"),brand&&(o.addClass(form,brand),brand=="amex"?formatter.resetPattern("{{9999}} {{9999999}} {{99999}}"):brand=="diners"?formatter.resetPattern("{{9999}} {{999999}} {{9999}}"):formatter.resetPattern("{{9999}} {{9999}} {{9999}} {{9999}}"))})}else attr=="expiration"?new Formatter(inputs[t],{pattern:"{{99}}/{{99}}",persistent:!1}):attr=="verification_value"&&new Formatter(inputs[t],{pattern:"{{9999}}",persistent:!1})}}}}();dispatchOnLoad(function(){Iugu.setup()});
